#!/usr/bin/env python3
"""Generate section files from curriculum plan JSON."""

from __future__ import annotations

import argparse
import json
from pathlib import Path


STACK_FILE_MAP = {
    "javascript": ("exercise.js", "solution.js", "test.js", "node test.js"),
    "react": ("exercise.jsx", "solution.jsx", "test.js", "node test.js"),
    "python": ("exercise.py", "solution.py", "test.py", "python test.py"),
    "fastapi": ("exercise.py", "solution.py", "test.py", "python test.py"),
}


def render_concept(section_title: str) -> str:
    return f"""# {section_title}

> 난이도: 1-3/5
> 선수 지식: 이전 섹션

## 학습 목표

- 핵심 개념을 이해하고 설명할 수 있다
- 실습 문제를 스스로 해결할 수 있다

## 핵심 개념

### 개념 1

이 섹션의 첫 번째 핵심 개념을 설명한다.

### 개념 2

실습에 직접 연결되는 두 번째 개념을 설명한다.

## 예제 코드

실습 파일을 참고해 동작을 확인한다.

## 주의사항

- 경계 조건을 반드시 테스트한다
- 동작만 맞추지 말고 가독성도 유지한다
"""


def render_exercise_md(section_title: str, run_command: str) -> str:
    return f"""# {section_title} 실습

## 문제

핵심 개념을 활용해 기능을 구현한다.

## 요구사항

- 요구사항을 모두 만족한다
- 최소 1개 이상의 엣지 케이스를 처리한다
- 테스트 코드를 통과한다

## 실행 방법

```bash
{run_command}
```

## 체크리스트

- [ ] 요구사항 충족
- [ ] 엣지 케이스 처리
- [ ] 테스트 통과
"""


def render_exercise_code(stack: str) -> str:
    if stack in {"javascript", "react"}:
        return """// TODO: 요구사항에 맞게 함수를 구현하세요.
function solve(input) {
  return input;
}

module.exports = { solve };
"""
    return """# TODO: 요구사항에 맞게 함수를 구현하세요.
def solve(input_value):
    return input_value
"""


def render_solution_code(stack: str) -> str:
    if stack in {"javascript", "react"}:
        return """function solve(input) {
  return input;
}

module.exports = { solve };
"""
    return """def solve(input_value):
    return input_value
"""


def render_test_code(stack: str, exercise_file: str) -> str:
    if stack in {"javascript", "react"}:
        return f"""// 실행: node test.js
const {{ solve }} = require("./{exercise_file}");

console.assert(solve("ok") === "ok", "기본 동작 테스트 실패");
console.assert(solve(1) === 1, "숫자 동작 테스트 실패");
console.log("모든 테스트 통과");
"""
    return f"""# 실행: python test.py
from exercise import solve

assert solve("ok") == "ok", "기본 동작 테스트 실패"
assert solve(1) == 1, "숫자 동작 테스트 실패"
print("모든 테스트 통과")
"""


def generate_section(base_dir: Path, stack: str, chapter: dict, section: dict) -> None:
    chapter_dir = base_dir / chapter["slug"]
    section_dir = chapter_dir / section["slug"]
    section_dir.mkdir(parents=True, exist_ok=True)

    exercise_file, solution_file, test_file, run_command = STACK_FILE_MAP[stack]
    (section_dir / "concept.md").write_text(render_concept(section["title"]), encoding="utf-8")
    (section_dir / "exercise.md").write_text(
        render_exercise_md(section["title"], run_command), encoding="utf-8"
    )
    (section_dir / exercise_file).write_text(render_exercise_code(stack), encoding="utf-8")
    (section_dir / solution_file).write_text(render_solution_code(stack), encoding="utf-8")
    (section_dir / test_file).write_text(render_test_code(stack, exercise_file), encoding="utf-8")


def main() -> None:
    parser = argparse.ArgumentParser(description="Generate section files from plan JSON.")
    parser.add_argument("--plan", required=True, help="Path to plan JSON generated by curriculum_planner.py")
    parser.add_argument("--base-dir", default="generated-course")
    parser.add_argument("--chapter-index", type=int, default=0)
    parser.add_argument("--section-index", type=int, default=0)
    parser.add_argument("--all", action="store_true")
    args = parser.parse_args()

    with open(args.plan, "r", encoding="utf-8") as file:
        plan = json.load(file)

    stack = plan.get("stack", "python")
    if stack not in STACK_FILE_MAP:
        stack = "python"

    base_dir = Path(args.base_dir)
    base_dir.mkdir(parents=True, exist_ok=True)

    if args.all:
        for chapter in plan["chapters"]:
            for section in chapter["sections"]:
                generate_section(base_dir, stack, chapter, section)
        print(f"Generated all sections under: {base_dir}")
        return

    chapter_index = max(1, args.chapter_index) if args.chapter_index else 1
    section_index = max(1, args.section_index) if args.section_index else 1

    try:
        chapter = plan["chapters"][chapter_index - 1]
        section = chapter["sections"][section_index - 1]
    except (IndexError, KeyError) as exc:
        raise SystemExit(f"Invalid chapter/section index: {exc}") from exc

    generate_section(base_dir, stack, chapter, section)
    print(f"Generated chapter {chapter_index}, section {section_index} under: {base_dir}")


if __name__ == "__main__":
    main()

