# Ch06: 미들웨어와 CORS

> **난이도**: ⭐⭐⭐ (3/5)
> **선수 지식**: Ch05 의존성 주입 완료
> **예상 학습 시간**: 3~4시간

---

## 개요

웹 API를 운영하다 보면, 모든 요청에 공통적으로 적용해야 하는 로직이 있습니다.
예를 들어, 요청 처리 시간 측정, 로깅, 인증 검사, CORS 헤더 추가 등이 그렇습니다.

**미들웨어(Middleware)**는 요청이 라우트 핸들러에 도달하기 전과 응답이 클라이언트에 반환되기 전에
**요청/응답 파이프라인을 가로채서** 공통 로직을 수행하는 메커니즘입니다.

### 미들웨어 파이프라인

```
클라이언트 요청
    │
    ▼
┌──────────────────┐
│  미들웨어 1 (전처리) │
└──────┬───────────┘
       ▼
┌──────────────────┐
│  미들웨어 2 (전처리) │
└──────┬───────────┘
       ▼
┌──────────────────┐
│   라우트 핸들러    │
└──────┬───────────┘
       ▼
┌──────────────────┐
│  미들웨어 2 (후처리) │
└──────┬───────────┘
       ▼
┌──────────────────┐
│  미들웨어 1 (후처리) │
└──────┬───────────┘
       ▼
클라이언트 응답
```

이 챕터에서는 FastAPI에서 미들웨어를 작성하는 방법과,
프론트엔드-백엔드 통신에 필수적인 **CORS(Cross-Origin Resource Sharing)** 설정을 학습합니다.

---

## 섹션 목록

| 섹션 | 제목 | 난이도 | 핵심 내용 |
|------|------|--------|----------|
| sec01 | [미들웨어 기본](./sec01-middleware-basics/concept.md) | ⭐⭐⭐ (3/5) | `@app.middleware`, `call_next`, 처리 순서 |
| sec02 | [CORS 설정](./sec02-cors/concept.md) | ⭐⭐⭐ (3/5) | `CORSMiddleware`, `allow_origins`, preflight |
| sec03 | [커스텀 미들웨어](./sec03-custom-middleware/concept.md) | ⭐⭐⭐ (3/5) | `BaseHTTPMiddleware`, 클래스 기반, 조건부 처리 |

---

## 학습 순서

```
sec01-middleware-basics → sec02-cors → sec03-custom-middleware
```

1. **sec01**: `@app.middleware("http")`를 사용한 기본 미들웨어 작성법을 학습합니다.
2. **sec02**: CORS의 개념과 FastAPI에서의 설정 방법을 학습합니다.
3. **sec03**: 클래스 기반의 재사용 가능한 커스텀 미들웨어를 구현합니다.

각 섹션에서:
1. `concept.md`를 읽고 개념을 이해합니다.
2. `exercise.md`의 문제를 확인합니다.
3. `exercise.py`에서 TODO를 완성합니다.
4. `python exercise.py`로 테스트를 실행합니다.
5. 막히면 `solution.py`를 참고합니다.

---

## 사전 준비

```bash
# 필요한 패키지 설치 (FastAPI, Uvicorn은 이미 설치되어 있어야 합니다)
pip install fastapi uvicorn httpx
```

---

## 이 챕터를 마치면 할 수 있는 것

- `@app.middleware("http")`를 사용하여 기본 미들웨어를 작성할 수 있다
- 미들웨어 체인의 실행 순서를 이해하고 설명할 수 있다
- `CORSMiddleware`를 사용하여 CORS를 올바르게 설정할 수 있다
- `allow_origins=["*"]`의 보안 위험성을 설명할 수 있다
- `BaseHTTPMiddleware`를 상속한 클래스 기반 미들웨어를 구현할 수 있다
- 실무에서 유용한 미들웨어(로깅, API 키 검증, 요청 ID)를 설계할 수 있다
